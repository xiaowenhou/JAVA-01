**第三课作业第三题**

题目： (选做)如果自己本地有可以运行的项目，可以按照2的方式进行演练。

使用Linux服务器上的web项目演练， 因为更贴近真实工作场景。

LInux服务器配置：Centos7系统，4核16G，服务器中有两个应用，一个Mysql， 一个Java的web应用。



压测命令为

```
ab -c 20 -t 30 http://localhost:8080/motorcycle/banner/list
```

**1.使用默认的参数进行压测**

​	参数为：

```
java  -XX:+PrintGCDetails -XX:+PrintGCDateStamps -Xloggc:/data/motorcycle/logs/gc.log -jar ${APP_NAME} 
```

```
仅打印部分GC日志
[root@motorcycle logs]# tail -200f gc.log 
OpenJDK 64-Bit Server VM (25.262-b10) for linux-amd64 JRE (1.8.0_262-b10), built on Aug  6 2020 16:24:19 by "mockbuild" with gcc 4.8.5 20150623 (Red Hat 4.8.5-39)
Memory: 4k page, physical 16265816k(11243440k free), swap 0k(0k free)
CommandLine flags: -XX:InitialHeapSize=260253056 -XX:MaxHeapSize=4164048896 -XX:+PrintGC -XX:+PrintGCDateStamps -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseParallelGC 
2021-01-18T15:29:07.395+0800: 0.592: [GC (Allocation Failure) [PSYoungGen: 64512K->3476K(74752K)] 64512K->3484K(245760K), 0.0039788 secs] [Times: user=0.01 sys=0.00, real=0.00 secs] 
2021-01-18T15:29:07.586+0800: 0.782: [GC (Allocation Failure) [PSYoungGen: 67988K->4292K(74752K)] 67996K->4308K(245760K), 0.0049846 secs] [Times: user=0.01 sys=0.01, real=0.00 secs] 
2021-01-18T15:29:07.730+0800: 0.926: [GC (Allocation Failure) [PSYoungGen: 68804K->4823K(74752K)] 68820K->4847K(245760K), 0.0051677 secs] [Times: user=0.01 sys=0.00, real=0.01 secs] 
2021-01-18T15:29:07.866+0800: 1.063: [GC (Allocation Failure) [PSYoungGen: 69335K->5028K(139264K)] 69359K->5060K(310272K), 0.0057181 secs] [Times: user=0.02 sys=0.00, real=0.00 secs] 
启动时发生的GC是因为新生代空间不足，进行扩容，因为堆空间很小， 所以GC只用了几ms
2021-01-18T15:29:09.142+0800: 2.338: [GC (Metadata GC Threshold) [PSYoungGen: 33064K->5316K(139264K)] 33096K->5420K(310272K), 0.0065640 secs] [Times: user=0.02 sys=0.00, real=0.01 secs] 
2021-01-18T15:29:09.148+0800: 2.345: [Full GC (Metadata GC Threshold) [PSYoungGen: 5316K->0K(139264K)] [ParOldGen: 104K->5279K(94720K)] 5420K->5279K(233984K), [Metaspace: 20564K->20564K(1069056K)], 0.0308340 secs] [Times: user=0.06 sys=0.01, real=0.03 secs] 
2021-01-18T15:29:09.665+0800: 2.861: [GC (Allocation Failure) [PSYoungGen: 129024K->2912K(208384K)] 134303K->8199K(303104K), 0.0054679 secs] [Times: user=0.02 sys=0.00, real=0.00 secs] 
2021-01-18T15:29:10.070+0800: 3.266: [GC (Allocation Failure) [PSYoungGen: 208224K->4916K(260608K)] 213511K->10211K(355328K), 0.0065947 secs] [Times: user=0.02 sys=0.00, real=0.01 secs] 
2021-01-18T15:29:10.832+0800: 4.028: [GC (Metadata GC Threshold) [PSYoungGen: 216632K->6624K(330240K)] 221927K->13241K(424960K), 0.0093175 secs] [Times: user=0.03 sys=0.01, real=0.01 secs] 
2021-01-18T15:29:10.841+0800: 4.038: [Full GC (Metadata GC Threshold) [PSYoungGen: 6624K->0K(330240K)] [ParOldGen: 6617K->12770K(156160K)] 13241K->12770K(486400K), [Metaspace: 34215K->34215K(1081344K)], 0.0609693 secs] [Times: user=0.16 sys=0.00, real=0.06 secs] 
启动时的几次FULLGC都是由于Metaspace空间满了扩容导致的，因为默认初始Metaspace空间的值很小
2021-01-18T15:29:12.116+0800: 5.313: [GC (Allocation Failure) [PSYoungGen: 323584K->7668K(331264K)] 336354K->22545K(487424K), 0.0087985 secs] [Times: user=0.05 sys=0.00, real=0.04 secs] 
2021-01-18T15:29:12.923+0800: 6.119: [GC (Allocation Failure) [PSYoungGen: 331252K->9701K(403456K)] 346129K->26282K(559616K), 0.0102229 secs] [Times: user=0.04 sys=0.00, real=0.01 secs] 
2021-01-18T15:29:14.246+0800: 7.442: [GC (Metadata GC Threshold) [PSYoungGen: 242672K->6096K(404992K)] 259253K->32316K(561152K), 0.0127723 secs] [Times: user=0.04 sys=0.01, real=0.01 secs] 
2021-01-18T15:29:14.259+0800: 7.455: [Full GC (Metadata GC Threshold) [PSYoungGen: 6096K->0K(404992K)] [ParOldGen: 26220K->30752K(238080K)] 32316K->30752K(643072K), [Metaspace: 56933K->56933K(1101824K)], 0.1354020 secs] [Times: user=0.43 sys=0.00, real=0.14 secs] 
这次FULLGC， 耗时135ms
以上为启动时的GC日志
以下为压测时的GC日志
2021-01-18T15:29:15.609+0800: 8.805: [GC (Allocation Failure) [PSYoungGen: 393728K->7424K(469504K)] 424480K->38184K(707584K), 0.0122892 secs] [Times: user=0.04 sys=0.01, real=0.01 secs] 
年轻代经过本次回收，减少了377.2M， 整个堆减少了377.2M，说明经过这次GC， 并没有发生对象提升到老年代，本次GC时间12ms
2021-01-18T15:29:59.690+0800: 52.886: [GC (Allocation Failure) [PSYoungGen: 469248K->10737K(482816K)] 500008K->44434K(720896K), 0.0213277 secs] [Times: user=0.06 sys=0.01, real=0.02 secs] 
2021-01-18T15:30:01.340+0800: 54.536: [GC (Allocation Failure) [PSYoungGen: 482801K->7476K(541184K)] 516498K->46458K(779264K), 0.0170756 secs] [Times: user=0.05 sys=0.01, real=0.02 secs] 
2021-01-18T15:30:03.030+0800: 56.226: [GC (Allocation Failure) [PSYoungGen: 535348K->7428K(540672K)] 574330K->46409K(778752K), 0.0108576 secs] [Times: user=0.04 sys=0.01, real=0.01 secs] 
2021-01-18T15:30:04.272+0800: 57.469: [GC (Allocation Failure) [PSYoungGen: 535300K->7509K(612352K)] 574281K->46498K(850432K), 0.0118013 secs] [Times: user=0.03 sys=0.00, real=0.02 secs] 
2021-01-18T15:30:05.470+0800: 58.666: [GC (Allocation Failure) [PSYoungGen: 607573K->7461K(612352K)] 646562K->46458K(850432K), 0.0117081 secs] [Times: user=0.03 sys=0.01, real=0.01 secs] 
2021-01-18T15:30:06.377+0800: 59.573: [GC (Allocation Failure) [PSYoungGen: 607525K->7493K(668672K)] 646522K->46490K(906752K), 0.0133607 secs] [Times: user=0.05 sys=0.01, real=0.01 secs] 
2021-01-18T15:30:07.513+0800: 60.709: [GC (Allocation Failure) [PSYoungGen: 664389K->7541K(668672K)] 703386K->46538K(906752K), 0.0103653 secs] [Times: user=0.03 sys=0.01, real=0.01 secs] 
2021-01-18T15:30:08.690+0800: 61.887: [GC (Allocation Failure) [PSYoungGen: 664437K->7605K(732672K)] 703434K->46602K(970752K), 0.0102653 secs] [Times: user=0.03 sys=0.00, real=0.01 secs] 
2021-01-18T15:30:09.682+0800: 62.878: [GC (Allocation Failure) [PSYoungGen: 730549K->7557K(734208K)] 769546K->46554K(972288K), 0.0090548 secs] [Times: user=0.02 sys=0.00, real=0.01 secs] 
2021-01-18T15:30:10.570+0800: 63.767: [GC (Allocation Failure) [PSYoungGen: 730501K->7572K(805376K)] 769498K->46569K(1043456K), 0.0108542 secs] [Times: user=0.03 sys=0.00, real=0.01 secs] 
2021-01-18T15:30:11.615+0800: 64.812: [GC (Allocation Failure) [PSYoungGen: 802196K->7589K(805376K)] 841193K->46586K(1043456K), 0.0114189 secs] [Times: user=0.04 sys=0.00, real=0.01 secs] 
2021-01-18T15:30:12.813+0800: 66.009: [GC (Allocation Failure) [PSYoungGen: 802213K->7589K(882688K)] 841210K->46586K(1120768K), 0.0099613 secs] [Times: user=0.03 sys=0.01, real=0.01 secs] 
2021-01-18T15:30:14.340+0800: 67.537: [GC (Allocation Failure) [PSYoungGen: 882597K->7604K(885760K)] 921594K->46601K(1123840K), 0.0133450 secs] [Times: user=0.03 sys=0.00, real=0.01 secs] 
2021-01-18T15:30:15.632+0800: 68.828: [GC (Allocation Failure) [PSYoungGen: 883124K->7621K(950272K)] 922121K->46618K(1188352K), 0.0126160 secs] [Times: user=0.04 sys=0.01, real=0.02 secs] 
2021-01-18T15:30:16.813+0800: 70.009: [GC (Allocation Failure) [PSYoungGen: 947653K->7652K(949760K)] 986650K->46649K(1187840K), 0.0097122 secs] [Times: user=0.03 sys=0.01, real=0.01 secs] 
2021-01-18T15:30:17.791+0800: 70.987: [GC (Allocation Failure) [PSYoungGen: 947684K->2340K(1017344K)] 986681K->46617K(1255424K), 0.0098125 secs] [Times: user=0.03 sys=0.00, real=0.01 secs] 
2021-01-18T15:30:18.521+0800: 71.717: [GC (Allocation Failure) [PSYoungGen: 1009956K->416K(1017856K)] 1054233K->46534K(1255936K), 0.0046619 secs] [Times: user=0.01 sys=0.00, real=0.01 secs] 
2021-01-18T15:30:19.211+0800: 72.407: [GC (Allocation Failure) [PSYoungGen: 1008032K->384K(1080832K)] 1054150K->46550K(1318912K), 0.0042931 secs] [Times: user=0.01 sys=0.00, real=0.01 secs] 
2021-01-18T15:30:19.916+0800: 73.112: [GC (Allocation Failure) [PSYoungGen: 1073024K->384K(1084416K)] 1119190K->46582K(1322496K), 0.0033873 secs] [Times: user=0.01 sys=0.00, real=0.00 secs] 
2021-01-18T15:30:20.613+0800: 73.810: [GC (Allocation Failure) [PSYoungGen: 1073024K->352K(1144320K)] 1119222K->46574K(1382400K), 0.0043663 secs] [Times: user=0.01 sys=0.00, real=0.01 secs] 
2021-01-18T15:30:21.454+0800: 74.651: [GC (Allocation Failure) [PSYoungGen: 1134432K->416K(1146368K)] 1180654K->46662K(1384448K), 0.0046069 secs] [Times: user=0.01 sys=0.00, real=0.00 secs] 
2021-01-18T15:30:22.332+0800: 75.529: [GC (Allocation Failure) [PSYoungGen: 1134496K->416K(1193984K)] 1180742K->46702K(1432064K), 0.0048783 secs] [Times: user=0.01 sys=0.01, real=0.01 secs] 
2021-01-18T15:30:23.164+0800: 76.360: [GC (Allocation Failure) [PSYoungGen: 1184160K->320K(1196032K)] 1230446K->46638K(1434112K), 0.0043489 secs] [Times: user=0.02 sys=0.00, real=0.01 secs] 
2021-01-18T15:30:23.956+0800: 77.153: [GC (Allocation Failure) [PSYoungGen: 1184064K->288K(1245696K)] 1230382K->46638K(1483776K), 0.0073835 secs] [Times: user=0.01 sys=0.00, real=0.00 secs] 
通过GC， 年轻代减少了1156.03M， 整个堆减少了1156M， 有30KB的数据晋升到了老年代，对象提升速率正常， 但是分配速率过高，简单计算了下， 对象分配速率在前几秒就有几百M/s，后期更是达到了1G以上/s。


```

压测结果：

```
Requests per second:    1959.10 [#/sec] (mean)
```

**结论：通过GC日志可以看到， 每一次通过GC，新生代的大小都在提升，并且GC间隔时间很短，基本上1秒左右就发生了一次GC，而且GC的停顿时间很短，说明新生代的大小有些小，导致在压力下YGC过于频繁**



2.**换成SerialGC默认参数压测**

参数为：

```
java  -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+UseSerialGC -Xloggc:/data/motorcycle/logs/gc.log -jar ${APP_NAME} 
```

压测结果：

```
Requests per second:    1850.36 [#/sec] (mean)
```

GC日志：

```
OpenJDK 64-Bit Server VM (25.262-b10) for linux-amd64 JRE (1.8.0_262-b10), built on Aug  6 2020 16:24:19 by "mockbuild" with gcc 4.8.5 20150623 (Red Hat 4.8.5-39)
Memory: 4k page, physical 16265816k(11213672k free), swap 0k(0k free)
CommandLine flags: -XX:InitialHeapSize=260253056 -XX:MaxHeapSize=4164048896 -XX:+PrintGC -XX:+PrintGCDateStamps -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseSerialGC 
以上为启动参数， 初始堆大小为248M，最大堆大小为3971M
2021-01-18T19:24:04.432+0800: 0.566: [GC (Allocation Failure) 2021-01-18T19:24:04.432+0800: 0.566: [DefNew: 68288K->3359K(76800K), 0.0083735 secs] 68288K->3359K(247488K), 0.0084750 secs] [Times: user=0.02 sys=0.00, real=0.01 secs] 
2021-01-18T19:24:04.634+0800: 0.768: [GC (Allocation Failure) 2021-01-18T19:24:04.634+0800: 0.768: [DefNew: 71647K->4243K(76800K), 0.0098827 secs] 71647K->4243K(247488K), 0.0099516 secs] [Times: user=0.03 sys=0.00, real=0.00 secs] 
2021-01-18T19:24:04.797+0800: 0.932: [GC (Allocation Failure) 2021-01-18T19:24:04.797+0800: 0.932: [DefNew: 72531K->4716K(76800K), 0.0112668 secs] 72531K->4716K(247488K), 0.0113537 secs] [Times: user=0.02 sys=0.00, real=0.01 secs] 
2021-01-18T19:24:04.954+0800: 1.089: [GC (Allocation Failure) 2021-01-18T19:24:04.954+0800: 1.089: [DefNew: 73004K->2312K(76800K), 0.0101485 secs] 73004K->5227K(247488K), 0.0102147 secs] [Times: user=0.01 sys=0.00, real=0.01 secs] 
2021-01-18T19:24:04.983+0800: 1.117: [Full GC (Metadata GC Threshold) 2021-01-18T19:24:04.983+0800: 1.117: [Tenured: 2914K->5302K(170688K), 0.0212738 secs] 14801K->5302K(247488K), [Metaspace: 20630K->20630K(1069056K)], 0.0213661 secs] [Times: user=0.02 sys=0.00, real=0.03 secs] 
2021-01-18T19:24:05.313+0800: 1.448: [GC (Allocation Failure) 2021-01-18T19:24:05.313+0800: 1.448: [DefNew: 68352K->1444K(76864K), 0.0068207 secs] 73654K->6747K(247552K), 0.0068940 secs] [Times: user=0.02 sys=0.00, real=0.01 secs] 
2021-01-18T19:24:05.493+0800: 1.627: [GC (Allocation Failure) 2021-01-18T19:24:05.493+0800: 1.627: [DefNew: 69796K->2745K(76864K), 0.0069051 secs] 75099K->8047K(247552K), 0.0069710 secs] [Times: user=0.02 sys=0.00, real=0.01 secs] 
2021-01-18T19:24:05.618+0800: 1.753: [GC (Allocation Failure) 2021-01-18T19:24:05.618+0800: 1.753: [DefNew: 71097K->3547K(76864K), 0.0070052 secs] 76399K->8849K(247552K), 0.0070851 secs] [Times: user=0.01 sys=0.00, real=0.01 secs] 
2021-01-18T19:24:05.789+0800: 1.924: [GC (Allocation Failure) 2021-01-18T19:24:05.789+0800: 1.924: [DefNew: 71899K->4181K(76864K), 0.0082689 secs] 77201K->9483K(247552K), 0.0083481 secs] [Times: user=0.01 sys=0.00, real=0.01 secs] 
2021-01-18T19:24:05.943+0800: 2.078: [GC (Allocation Failure) 2021-01-18T19:24:05.943+0800: 2.078: [DefNew: 72533K->4762K(76864K), 0.0099983 secs] 77835K->10064K(247552K), 0.0100753 secs] [Times: user=0.01 sys=0.00, real=0.01 secs] 
2021-01-18T19:24:06.208+0800: 2.343: [GC (Allocation Failure) 2021-01-18T19:24:06.208+0800: 2.343: [DefNew: 73114K->4389K(76864K), 0.0117589 secs] 78416K->10906K(247552K), 0.0118237 secs] [Times: user=0.03 sys=0.00, real=0.01 secs] 
2021-01-18T19:24:06.524+0800: 2.658: [GC (Allocation Failure) 2021-01-18T19:24:06.524+0800: 2.658: [DefNew: 72741K->4425K(76864K), 0.0156400 secs] 79258K->12208K(247552K), 0.0157234 secs] [Times: user=0.02 sys=0.00, real=0.02 secs] 
2021-01-18T19:24:06.788+0800: 2.922: [GC (Allocation Failure) 2021-01-18T19:24:06.788+0800: 2.922: [DefNew: 72777K->4697K(76864K), 0.0146339 secs] 80560K->13132K(247552K), 0.0147093 secs] [Times: user=0.03 sys=0.00, real=0.01 secs] 
2021-01-18T19:24:06.817+0800: 2.952: [Full GC (Metadata GC Threshold) 2021-01-18T19:24:06.817+0800: 2.952: [Tenured: 8435K->12970K(170688K), 0.0499113 secs] 15768K->12970K(247552K), [Metaspace: 34221K->34221K(1081344K)], 0.0499885 secs] [Times: user=0.11 sys=0.00, real=0.05 secs] 
FULLGC， 用时50ms， GC原因是元数据区满了
2021-01-18T19:24:07.165+0800: 3.300: [GC (Allocation Failure) 2021-01-18T19:24:07.165+0800: 3.300: [DefNew: 68352K->2247K(76864K), 0.0089687 secs] 81322K->15217K(247552K), 0.0090462 secs] [Times: user=0.01 sys=0.00, real=0.01 secs] 
2021-01-18T19:24:07.755+0800: 3.890: [GC (Allocation Failure) 2021-01-18T19:24:07.755+0800: 3.890: [DefNew: 70599K->8225K(76864K), 0.0139228 secs] 83569K->21195K(247552K), 0.0140063 secs] [Times: user=0.04 sys=0.00, real=0.01 secs] 
2021-01-18T19:24:07.955+0800: 4.090: [GC (Allocation Failure) 2021-01-18T19:24:07.955+0800: 4.090: [DefNew: 76577K->748K(76864K), 0.0190427 secs] 89547K->21567K(247552K), 0.0191339 secs] [Times: user=0.03 sys=0.00, real=0.02 secs] 
2021-01-18T19:24:08.110+0800: 4.245: [GC (Allocation Failure) 2021-01-18T19:24:08.110+0800: 4.245: [DefNew: 69100K->1319K(76864K), 0.0055530 secs] 89919K->22138K(247552K), 0.0056447 secs] [Times: user=0.01 sys=0.00, real=0.01 secs] 
2021-01-18T19:24:08.215+0800: 4.350: [GC (Allocation Failure) 2021-01-18T19:24:08.215+0800: 4.350: [DefNew: 69671K->1907K(76864K), 0.0048169 secs] 90490K->22726K(247552K), 0.0048821 secs] [Times: user=0.01 sys=0.00, real=0.00 secs] 
2021-01-18T19:24:08.304+0800: 4.439: [GC (Allocation Failure) 2021-01-18T19:24:08.304+0800: 4.439: [DefNew: 70259K->2284K(76864K), 0.0068513 secs] 91078K->23103K(247552K), 0.0069253 secs] [Times: user=0.02 sys=0.00, real=0.00 secs] 
2021-01-18T19:24:08.394+0800: 4.529: [GC (Allocation Failure) 2021-01-18T19:24:08.394+0800: 4.529: [DefNew: 70636K->2914K(76864K), 0.0063180 secs] 91455K->23733K(247552K), 0.0063883 secs] [Times: user=0.02 sys=0.00, real=0.00 secs] 
2021-01-18T19:24:08.559+0800: 4.694: [GC (Allocation Failure) 2021-01-18T19:24:08.559+0800: 4.694: [DefNew: 71266K->3537K(76864K), 0.0079853 secs] 92085K->24356K(247552K), 0.0080517 secs] [Times: user=0.02 sys=0.00, real=0.01 secs] 
2021-01-18T19:24:08.945+0800: 5.080: [GC (Allocation Failure) 2021-01-18T19:24:08.945+0800: 5.080: [DefNew: 71889K->4611K(76864K), 0.0107027 secs] 92708K->25430K(247552K), 0.0107751 secs] [Times: user=0.01 sys=0.00, real=0.01 secs] 
2021-01-18T19:24:09.399+0800: 5.534: [GC (Allocation Failure) 2021-01-18T19:24:09.399+0800: 5.534: [DefNew: 72963K->5976K(76864K), 0.0162837 secs] 93782K->27519K(247552K), 0.0163558 secs] [Times: user=0.03 sys=0.00, real=0.02 secs] 
2021-01-18T19:24:09.717+0800: 5.851: [GC (Allocation Failure) 2021-01-18T19:24:09.717+0800: 5.851: [DefNew: 74328K->5399K(76864K), 0.0181498 secs] 95871K->29006K(247552K), 0.0182251 secs] [Times: user=0.03 sys=0.00, real=0.02 secs] 
2021-01-18T19:24:10.091+0800: 6.226: [GC (Allocation Failure) 2021-01-18T19:24:10.091+0800: 6.226: [DefNew: 73751K->5749K(76864K), 0.0178245 secs] 97358K->30997K(247552K), 0.0178999 secs] [Times: user=0.04 sys=0.00, real=0.02 secs] 
2021-01-18T19:24:10.253+0800: 6.387: [Full GC (Metadata GC Threshold) 2021-01-18T19:24:10.253+0800: 6.388: [Tenured: 25247K->31598K(170688K), 0.1067061 secs] 62393K->31598K(247552K), [Metaspace: 56881K->56881K(1101824K)], 0.1067797 secs] [Times: user=0.17 sys=0.01, real=0.11 secs] 
2021-01-18T19:24:10.530+0800: 6.665: [GC (Allocation Failure) 2021-01-18T19:24:10.530+0800: 6.665: [DefNew: 68352K->758K(76864K), 0.0055706 secs] 99950K->32356K(247552K), 0.0056421 secs] [Times: user=0.02 sys=0.00, real=0.01 secs] 
2021-01-18T19:24:10.757+0800: 6.892: [GC (Allocation Failure) 2021-01-18T19:24:10.757+0800: 6.892: [DefNew: 69110K->2030K(76864K), 0.0083678 secs] 100708K->33629K(247552K), 0.0084370 secs] [Times: user=0.02 sys=0.00, real=0.01 secs] 
2021-01-18T19:24:10.988+0800: 7.123: [GC (Allocation Failure) 2021-01-18T19:24:10.988+0800: 7.123: [DefNew: 70382K->3439K(76864K), 0.0117361 secs] 101981K->35037K(247552K), 0.0118052 secs] [Times: user=0.02 sys=0.00, real=0.01 secs] 
2021-01-18T19:24:11.254+0800: 7.389: [GC (Allocation Failure) 2021-01-18T19:24:11.254+0800: 7.389: [DefNew: 71791K->4513K(76864K), 0.0136954 secs] 103389K->36111K(247552K), 0.0137654 secs] [Times: user=0.04 sys=0.00, real=0.01 secs] 
2021-01-18T19:24:11.506+0800: 7.640: [GC (Allocation Failure) 2021-01-18T19:24:11.506+0800: 7.640: [DefNew: 72865K->4853K(76864K), 0.0150298 secs] 104463K->37124K(247552K), 0.0151274 secs] [Times: user=0.03 sys=0.00, real=0.01 secs] 
2021-01-18T19:24:11.677+0800: 7.811: [GC (Allocation Failure) 2021-01-18T19:24:11.677+0800: 7.811: [DefNew: 73205K->5149K(76864K), 0.0181069 secs] 105476K->38622K(247552K), 0.0182195 secs] [Times: user=0.05 sys=0.00, real=0.02 secs] 
2021-01-18T19:24:11.834+0800: 7.969: [GC (Allocation Failure) 2021-01-18T19:24:11.834+0800: 7.969: [DefNew: 73501K->4706K(76864K), 0.0156003 secs] 106974K->39518K(247552K), 0.0156745 secs] [Times: user=0.03 sys=0.00, real=0.01 secs] 
以上为启动时的GC日志， 和并行GC一样， 由于Metaspace的大小， 堆要在应用启动过程中进行了几次FULLGC扩容， 除此之外，串行GC没有并行GC的自适应调整堆内存大小的功能，因此新生代大小一直是75M左右， 而堆的分配速率在300M以上， 因此，新生代发生了频繁的GC， 几乎每隔一两百ms就会发生一次。
以下为压测时的GC日志，由于GC日志过长， 仅截取了一部分
2021-01-18T19:24:55.020+0800: 51.154: [GC (Allocation Failure) 2021-01-18T19:24:55.020+0800: 51.154: [DefNew: 73058K->4367K(76864K), 0.0155887 secs] 107870K->40234K(247552K), 0.0157236 secs] [Times: user=0.02 sys=0.00, real=0.02 secs] 
2021-01-18T19:24:55.350+0800: 51.485: [GC (Allocation Failure) 2021-01-18T19:24:55.350+0800: 51.485: [DefNew: 72719K->4350K(76864K), 0.0165448 secs] 108586K->41176K(247552K), 0.0167089 secs] [Times: user=0.04 sys=0.00, real=0.02 secs] 
2021-01-18T19:24:55.668+0800: 51.803: [GC (Allocation Failure) 2021-01-18T19:24:55.668+0800: 51.803: [DefNew: 72702K->5803K(76864K), 0.0189526 secs] 109528K->44116K(247552K), 0.0191176 secs] [Times: user=0.05 sys=0.00, real=0.02 secs] 
2021-01-18T19:24:56.004+0800: 52.138: [GC (Allocation Failure) 2021-01-18T19:24:56.004+0800: 52.138: [DefNew: 74155K->5200K(76864K), 0.0153568 secs] 112468K->45352K(247552K), 0.0155106 secs] [Times: user=0.02 sys=0.00, real=0.01 secs] 
```

**结论：通过堆GC日志的分析， 可以看出， SerialGC没有自适应机制， 没有在YGC中进行动态扩容， 因此，虽然没有发生FULLGC， 但是YGC发生的非常频繁， 几乎一两百ms就会发生一次，整体吞吐量也不如ParallelGC**

**3.换成CMSGC默认参数压测**

​	参数为：

```
java  -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+UseConcMarkSweepGC -Xloggc:/data/motorcycle/logs/gc.log -jar ${APP_NAME} 
```

​	压测结果：

```
Requests per second:    1778.00 [#/sec] (mean)
```

GC日志

```
OpenJDK 64-Bit Server VM (25.262-b10) for linux-amd64 JRE (1.8.0_262-b10), built on Aug  6 2020 16:24:19 by "mockbuild" with gcc 4.8.5 20150623 (Red Hat 4.8.5-39)
Memory: 4k page, physical 16265816k(11209340k free), swap 0k(0k free)
CommandLine flags: -XX:InitialHeapSize=260253056 -XX:MaxHeapSize=4164048896 -XX:MaxNewSize=348966912 -XX:MaxTenuringThreshold=6 -XX:OldPLABSize=16 -XX:+PrintGC -XX:+PrintGCDateStamps -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseConcMarkSweepGC -XX:+UseParNewGC 
2021-01-19T12:36:26.699+0800: 0.578: [GC (Allocation Failure) 2021-01-19T12:36:26.699+0800: 0.578: [ParNew: 68288K->3410K(76800K), 0.0045816 secs] 68288K->3410K(247488K), 0.0047310 secs] [Times: user=0.01 sys=0.01, real=0.00 secs] 
2021-01-19T12:36:26.923+0800: 0.802: [GC (Allocation Failure) 2021-01-19T12:36:26.923+0800: 0.802: [ParNew: 71698K->6321K(76800K), 0.0054286 secs] 71698K->6321K(247488K), 0.0055024 secs] [Times: user=0.01 sys=0.00, real=0.01 secs] 
2021-01-19T12:36:27.084+0800: 0.963: [GC (Allocation Failure) 2021-01-19T12:36:27.084+0800: 0.963: [ParNew: 74609K->3797K(76800K), 0.0183018 secs] 74609K->6772K(247488K), 0.0183670 secs] [Times: user=0.04 sys=0.01, real=0.01 secs] 
2021-01-19T12:36:27.233+0800: 1.112: [GC (GCLocker Initiated GC) 2021-01-19T12:36:27.233+0800: 1.112: [ParNew: 72086K->3440K(76800K), 0.0045723 secs] 75061K->6415K(247488K), 0.0046391 secs] [Times: user=0.02 sys=0.00, real=0.01 secs] 
2021-01-19T12:36:27.247+0800: 1.126: [GC (CMS Initial Mark) [1 CMS-initial-mark: 2975K(170688K)] 9356K(247488K), 0.0020177 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
2021-01-19T12:36:27.249+0800: 1.128: [CMS-concurrent-mark-start]
2021-01-19T12:36:27.265+0800: 1.144: [CMS-concurrent-mark: 0.015/0.015 secs] [Times: user=0.06 sys=0.00, real=0.02 secs] 
2021-01-19T12:36:27.265+0800: 1.144: [CMS-concurrent-preclean-start]
2021-01-19T12:36:27.266+0800: 1.145: [CMS-concurrent-preclean: 0.001/0.001 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
2021-01-19T12:36:27.266+0800: 1.145: [CMS-concurrent-abortable-preclean-start]
2021-01-19T12:36:27.512+0800: 1.391: [GC (Allocation Failure) 2021-01-19T12:36:27.512+0800: 1.391: [ParNew: 71728K->3657K(76800K), 0.0047656 secs] 74703K->6632K(247488K), 0.0048435 secs] [Times: user=0.02 sys=0.00, real=0.01 secs] 
2021-01-19T12:36:27.716+0800: 1.596: [CMS-concurrent-abortable-preclean: 0.230/0.451 secs] [Times: user=1.65 sys=0.04, real=0.45 secs] 
2021-01-19T12:36:27.717+0800: 1.596: [GC (CMS Final Remark) [YG occupancy: 53859 K (76800 K)]2021-01-19T12:36:27.717+0800: 1.596: [Rescan (parallel) , 0.0084990 secs]2021-01-19T12:36:27.725+0800: 1.605: [weak refs processing, 0.0000323 secs]2021-01-19T12:36:27.725+0800: 1.605: [class unloading, 0.0038346 secs]2021-01-19T12:36:27.729+0800: 1.608: [scrub symbol table, 0.0049549 secs]2021-01-19T12:36:27.734+0800: 1.613: [scrub string table, 0.0003781 secs][1 CMS-remark: 2975K(170688K)] 56834K(247488K), 0.0179407 secs] [Times: user=0.05 sys=0.00, real=0.02 secs] 
2021-01-19T12:36:27.736+0800: 1.615: [CMS-concurrent-sweep-start]
2021-01-19T12:36:27.737+0800: 1.616: [CMS-concurrent-sweep: 0.001/0.001 secs] [Times: user=0.01 sys=0.00, real=0.00 secs] 
2021-01-19T12:36:27.737+0800: 1.617: [CMS-concurrent-reset-start]
2021-01-19T12:36:27.762+0800: 1.641: [CMS-concurrent-reset: 0.025/0.025 secs] [Times: user=0.08 sys=0.02, real=0.02 secs] 
2021-01-19T12:36:27.786+0800: 1.666: [GC (Allocation Failure) 2021-01-19T12:36:27.786+0800: 1.666: [ParNew: 71945K->6173K(76800K), 0.0097533 secs] 74911K->9139K(247488K), 0.0098369 secs] [Times: user=0.03 sys=0.00, real=0.01 secs] 
2021-01-19T12:36:27.939+0800: 1.819: [GC (Allocation Failure) 2021-01-19T12:36:27.939+0800: 1.819: [ParNew: 74461K->6532K(76800K), 0.0069931 secs] 77427K->10502K(247488K), 0.0070770 secs] [Times: user=0.03 sys=0.00, real=0.01 secs] 
2021-01-19T12:36:28.149+0800: 2.029: [GC (Allocation Failure) 2021-01-19T12:36:28.149+0800: 2.029: [ParNew: 74820K->6769K(76800K), 0.0053341 secs] 78790K->11440K(247488K), 0.0054123 secs] [Times: user=0.02 sys=0.00, real=0.01 secs] 
2021-01-19T12:36:28.338+0800: 2.217: [GC (Allocation Failure) 2021-01-19T12:36:28.338+0800: 2.217: [ParNew: 75057K->5633K(76800K), 0.0069804 secs] 79728K->11055K(247488K), 0.0070703 secs] [Times: user=0.02 sys=0.01, real=0.01 secs] 
2021-01-19T12:36:28.668+0800: 2.547: [GC (Allocation Failure) 2021-01-19T12:36:28.668+0800: 2.547: [ParNew: 73921K->6557K(76800K), 0.0078781 secs] 79343K->12676K(247488K), 0.0079553 secs] [Times: user=0.03 sys=0.00, real=0.01 secs] 
2021-01-19T12:36:29.021+0800: 2.900: [GC (Allocation Failure) 2021-01-19T12:36:29.021+0800: 2.900: [ParNew: 74845K->6717K(76800K), 0.0070689 secs] 80964K->14284K(247488K), 0.0071546 secs] [Times: user=0.02 sys=0.00, real=0.01 secs] 
2021-01-19T12:36:29.346+0800: 3.225: [GC (Allocation Failure) 2021-01-19T12:36:29.346+0800: 3.225: [ParNew: 75005K->6543K(76800K), 0.0075235 secs] 82572K->14754K(247488K), 0.0076004 secs] [Times: user=0.03 sys=0.00, real=0.00 secs] 
2021-01-19T12:36:29.741+0800: 3.620: [GC (Allocation Failure) 2021-01-19T12:36:29.741+0800: 3.620: [ParNew: 74831K->8025K(76800K), 0.0104618 secs] 83042K->16818K(247488K), 0.0105362 secs] [Times: user=0.04 sys=0.00, real=0.01 secs] 
2021-01-19T12:36:30.420+0800: 4.299: [GC (Allocation Failure) 2021-01-19T12:36:30.420+0800: 4.299: [ParNew: 76313K->8512K(76800K), 0.0140707 secs] 85106K->22069K(247488K), 0.0141540 secs] [Times: user=0.04 sys=0.01, real=0.02 secs] 
2021-01-19T12:36:30.435+0800: 4.314: [GC (CMS Initial Mark) [1 CMS-initial-mark: 13557K(170688K)] 23406K(247488K), 0.0026352 secs] [Times: user=0.01 sys=0.00, real=0.00 secs] 
2021-01-19T12:36:30.438+0800: 4.317: [CMS-concurrent-mark-start]
2021-01-19T12:36:30.473+0800: 4.352: [CMS-concurrent-mark: 0.033/0.035 secs] [Times: user=0.10 sys=0.00, real=0.03 secs] 
2021-01-19T12:36:30.480+0800: 4.359: [CMS-concurrent-preclean-start]
2021-01-19T12:36:30.485+0800: 4.365: [CMS-concurrent-preclean: 0.002/0.005 secs] [Times: user=0.02 sys=0.00, real=0.01 secs] 
2021-01-19T12:36:30.486+0800: 4.365: [CMS-concurrent-abortable-preclean-start]
2021-01-19T12:36:30.669+0800: 4.548: [GC (Allocation Failure) 2021-01-19T12:36:30.669+0800: 4.548: [ParNew: 76800K->7413K(76800K), 0.0207935 secs] 90357K->29144K(247488K), 0.0208904 secs] [Times: user=0.07 sys=0.00, real=0.02 secs] 
2021-01-19T12:36:30.827+0800: 4.706: [GC (Allocation Failure) 2021-01-19T12:36:30.827+0800: 4.706: [ParNew: 75701K->1497K(76800K), 0.0038192 secs] 97432K->23229K(247488K), 0.0039058 secs] [Times: user=0.01 sys=0.00, real=0.00 secs] 
2021-01-19T12:36:30.833+0800: 4.712: [CMS-concurrent-abortable-preclean: 0.113/0.348 secs] [Times: user=1.33 sys=0.01, real=0.34 secs] 
2021-01-19T12:36:30.833+0800: 4.713: [GC (CMS Final Remark) [YG occupancy: 2836 K (76800 K)]2021-01-19T12:36:30.833+0800: 4.713: [Rescan (parallel) , 0.0043181 secs]2021-01-19T12:36:30.838+0800: 4.717: [weak refs processing, 0.0000525 secs]2021-01-19T12:36:30.838+0800: 4.717: [class unloading, 0.0097668 secs]2021-01-19T12:36:30.848+0800: 4.727: [scrub symbol table, 0.0146434 secs]2021-01-19T12:36:30.862+0800: 4.742: [scrub string table, 0.0009911 secs][1 CMS-remark: 21731K(170688K)] 24567K(247488K), 0.0300371 secs] [Times: user=0.09 sys=0.00, real=0.03 secs] 
2021-01-19T12:36:30.864+0800: 4.743: [CMS-concurrent-sweep-start]
2021-01-19T12:36:30.873+0800: 4.752: [CMS-concurrent-sweep: 0.009/0.009 secs] [Times: user=0.04 sys=0.00, real=0.01 secs] 
2021-01-19T12:36:30.873+0800: 4.752: [CMS-concurrent-reset-start]
2021-01-19T12:36:30.879+0800: 4.759: [CMS-concurrent-reset: 0.006/0.006 secs] [Times: user=0.02 sys=0.00, real=0.01 secs] 
2021-01-19T12:36:30.983+0800: 4.863: [GC (Allocation Failure) 2021-01-19T12:36:30.983+0800: 4.863: [ParNew: 69785K->2081K(76800K), 0.0040057 secs] 91285K->23581K(247488K), 0.0040759 secs] [Times: user=0.02 sys=0.00, real=0.01 secs] 
2021-01-19T12:36:31.083+0800: 4.963: [GC (Allocation Failure) 2021-01-19T12:36:31.083+0800: 4.963: [ParNew: 70369K->3001K(76800K), 0.0025968 secs] 91869K->24501K(247488K), 0.0026709 secs] [Times: user=0.01 sys=0.00, real=0.01 secs] 
2021-01-19T12:36:31.188+0800: 5.067: [GC (Allocation Failure) 2021-01-19T12:36:31.188+0800: 5.068: [ParNew: 71289K->4323K(76800K), 0.0056996 secs] 92789K->25824K(247488K), 0.0392062 secs] [Times: user=0.05 sys=0.00, real=0.04 secs] 
以上为启动日志
以下为压测日志， 仅截取部分
2021-01-19T12:36:31.418+0800: 5.297: [GC (Allocation Failure) 2021-01-19T12:36:31.418+0800: 5.297: [ParNew: 72611K->5371K(76800K), 0.0044012 secs] 94112K->26871K(247488K), 0.0044964 secs] [Times: user=0.01 sys=0.00, real=0.00 secs] 
2021-01-19T12:36:31.883+0800: 5.762: [GC (Allocation Failure) 2021-01-19T12:36:31.883+0800: 5.762: [ParNew: 73659K->4980K(76800K), 0.0078335 secs] 95159K->27246K(247488K), 0.0079128 secs] [Times: user=0.03 sys=0.00, real=0.01 secs]
```

**结论：CMS的年轻代默认使用ParNewGC，由于GC线程只有4个， 因此年轻代也比较小，导致YGC频繁，影响吞吐量， 但是通过CMS的老年代GC可以看到， CMS的一次老年代的GC， 整体停顿时间只有几ms， 这个停顿时间要小于SerialGC和ParallelGC的老年代GC的**

4. **换成G1GC默认参数压测**

   参数为：

   ```
   java  -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+UseG1GC -Xloggc:/data/motorcycle/logs/gc.log -jar ${APP_NAME} 
   ```

   压测结果：

   ```
   Requests per second:    1836.16 [#/sec] (mean)
   ```

   由于G1GC日志输出太多，因此第二遍，关闭了打印详细GC日志， 改为打印普通GC日志

   参数为：

   ```
   java  -XX:+PrintGC -XX:+PrintGCDateStamps -XX:+UseG1GC -Xloggc:/data/motorcycle/logs/gc.log -jar ${APP_NAME} 
   ```

   压测结果：

   ```
   Requests per second:    2022.16 [#/sec] (mean)
   ```

   **说明打印过于详细的GC日志也会消耗性能，因此在生产上的时候，一般可以关闭GC日志，当发现问题需要定位问题的时候再打开**

```
OpenJDK 64-Bit Server VM (25.262-b10) for linux-amd64 JRE (1.8.0_262-b10), built on Aug  6 2020 16:24:19 by "mockbuild" with gcc 4.8.5 20150623 (Red Hat 4.8.5-39)
Memory: 4k page, physical 16265816k(11187240k free), swap 0k(0k free)
CommandLine flags: -XX:InitialHeapSize=260253056 -XX:MaxHeapSize=4164048896 -XX:+PrintGC -XX:+PrintGCDateStamps -XX:+PrintGCTimeStamps -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseG1GC 
2021-01-19T12:50:45.355+0800: 0.238: [GC pause (G1 Evacuation Pause) (young) 15079K->2066K(250M), 0.0043051 secs]
2021-01-19T12:50:45.539+0800: 0.422: [GC pause (G1 Evacuation Pause) (young) 22546K->4317K(250M), 0.0046022 secs]
2021-01-19T12:50:45.858+0800: 0.741: [GC pause (G1 Evacuation Pause) (young) 78045K->4350K(250M), 0.0057444 secs]
2021-01-19T12:50:46.271+0800: 1.154: [GC pause (G1 Evacuation Pause) (young) 151M->7777K(250M), 0.0130345 secs]
2021-01-19T12:50:46.364+0800: 1.247: [GC pause (Metadata GC Threshold) (young) (initial-mark) 48333K->6963K(250M), 0.0080727 secs]
2021-01-19T12:50:46.372+0800: 1.256: [GC concurrent-root-region-scan-start]
2021-01-19T12:50:46.379+0800: 1.262: [GC concurrent-root-region-scan-end, 0.0065336 secs]
2021-01-19T12:50:46.379+0800: 1.262: [GC concurrent-mark-start]
2021-01-19T12:50:46.382+0800: 1.265: [GC concurrent-mark-end, 0.0029618 secs]
2021-01-19T12:50:46.382+0800: 1.265: [GC remark, 0.0064344 secs]
2021-01-19T12:50:46.399+0800: 1.282: [GC cleanup 18227K->18227K(250M), 0.0016100 secs]
2021-01-19T12:50:46.823+0800: 1.707: [GC pause (G1 Evacuation Pause) (young) 151M->9011K(250M), 0.0109896 secs]
2021-01-19T12:50:47.219+0800: 2.103: [GC pause (G1 Evacuation Pause) (young) 151M->10547K(250M), 0.0087328 secs]
2021-01-19T12:50:47.684+0800: 2.568: [GC pause (G1 Evacuation Pause) (young) 151M->12083K(250M), 0.0130108 secs]
2021-01-19T12:50:48.319+0800: 3.202: [GC pause (G1 Evacuation Pause) (young) 151M->14643K(250M), 0.0230023 secs]
2021-01-19T12:50:48.382+0800: 3.265: [GC pause (Metadata GC Threshold) (young) (initial-mark) 21811K->14743K(250M), 0.0184315 secs]
2021-01-19T12:50:48.400+0800: 3.284: [GC concurrent-root-region-scan-start]
2021-01-19T12:50:48.419+0800: 3.303: [GC concurrent-root-region-scan-end, 0.0189305 secs]
2021-01-19T12:50:48.419+0800: 3.303: [GC concurrent-mark-start]
2021-01-19T12:50:48.428+0800: 3.312: [GC concurrent-mark-end, 0.0089210 secs]
2021-01-19T12:50:48.428+0800: 3.312: [GC remark, 0.0073459 secs]
2021-01-19T12:50:48.436+0800: 3.319: [GC cleanup 20447K->20447K(250M), 0.0010289 secs]
2021-01-19T12:50:49.518+0800: 4.401: [GC pause (G1 Evacuation Pause) (young) (initial-mark) 153M->23497K(250M), 0.0162091 secs]
2021-01-19T12:50:49.534+0800: 4.418: [GC concurrent-root-region-scan-start]
2021-01-19T12:50:49.555+0800: 4.438: [GC concurrent-root-region-scan-end, 0.0206059 secs]
2021-01-19T12:50:49.555+0800: 4.438: [GC concurrent-mark-start]
2021-01-19T12:50:49.561+0800: 4.445: [GC concurrent-mark-end, 0.0064510 secs]
2021-01-19T12:50:49.561+0800: 4.445: [GC remark, 0.0085901 secs]
2021-01-19T12:50:49.570+0800: 4.454: [GC cleanup 29641K->29641K(250M), 0.0004977 secs]
2021-01-19T12:50:49.864+0800: 4.747: [GC pause (G1 Evacuation Pause) (young) 153M->26417K(250M), 0.0199991 secs]
2021-01-19T12:50:50.127+0800: 5.011: [GC pause (G1 Evacuation Pause) (young) 163M->26929K(250M), 0.0102376 secs]
2021-01-19T12:50:50.465+0800: 5.349: [GC pause (G1 Evacuation Pause) (young) 163M->30127K(250M), 0.0113312 secs]
2021-01-19T12:50:51.388+0800: 6.271: [GC pause (G1 Evacuation Pause) (young) 174M->34223K(250M), 0.0248145 secs]
2021-01-19T12:50:52.254+0800: 7.138: [GC pause (G1 Evacuation Pause) (young) 174M->37295K(250M), 0.0168031 secs]
2021-01-19T12:50:52.771+0800: 7.654: [GC pause (G1 Evacuation Pause) (young) 174M->39980K(250M), 0.0167523 secs]
2021-01-19T12:50:53.296+0800: 8.179: [GC pause (G1 Evacuation Pause) (young) 175M->42077K(250M), 0.0227796 secs]
2021-01-19T12:50:53.730+0800: 8.613: [GC pause (G1 Evacuation Pause) (young) 178M->46591K(250M), 0.0279975 secs]
2021-01-19T12:50:54.090+0800: 8.974: [GC pause (G1 Evacuation Pause) (young) 183M->48128K(250M), 0.0204444 secs]
以上为启动日志
以下为压测日志， 仅截取部分，因为全部都是年轻代的GC
2021-01-19T12:51:11.918+0800: 26.801: [GC pause (G1 Evacuation Pause) (young) 187M->53248K(250M), 0.0219944 secs]
2021-01-19T12:51:12.622+0800: 27.506: [GC pause (G1 Evacuation Pause) (young) 187M->54770K(250M), 0.0206456 secs]
2021-01-19T12:51:13.169+0800: 28.053: [GC pause (G1 Evacuation Pause) (young) 191M->56831K(250M), 0.0131357 secs]
2021-01-19T12:51:13.620+0800: 28.504: [GC pause (G1 Evacuation Pause) (young) 194M->56319K(250M), 0.0099064 secs]
2021-01-19T12:51:14.083+0800: 28.967: [GC pause (G1 Evacuation Pause) (young) 194M->56319K(250M), 0.0081580 secs]
2021-01-19T12:51:14.519+0800: 29.403: [GC pause (G1 Evacuation Pause) (young) 194M->57343K(250M), 0.0109114 secs]
2021-01-19T12:51:14.914+0800: 29.798: [GC pause (G1 Evacuation Pause) (young) 194M->56831K(250M), 0.0141410 secs]
2021-01-19T12:51:15.294+0800: 30.178: [GC pause (G1 Evacuation Pause) (young) 194M->56831K(250M), 0.0149219 secs]
```

**结论：可以看到G1GC的GC停顿时间也很短， 基本都在十几二十ms左右， 此外， G1GC也会根据应用的运行情况调整各个分代的大小， 通过GC日志可以看到， 一开始，年轻代只有几十M大小， 但是到后面，年轻代已经有200M左右，GC频率相对CMS和SerialGC要低一些， 但是由于每次GC的停顿时间可以满足G1GC的默认200ms以内，并且没有设置初始堆大小和最大堆大小，因此G1GC也没有对整个堆内存进行扩容，导致GC还是有些频繁， 说明默认的参数并不合理，如果在生产中部署该应用， 应该要调整该应用的JVM参数。**



**5.模拟生产环境， 调整参数，以求获得更高的吞吐量**

由于是一个普通的web应用， 请求在200ms左右返回即可， 因此该应用属于吞吐量优先响应时间要求并不高的应用，考虑使用ParallelGC，并且由于整个堆内存有16G， 考虑Mysql， Nginx， 系统本身都需要占据一定的内存， 因此应用的堆内存不宜过大， 暂定在4G。同时为了避免因为Metaspace空间不足导致FULLGC，在启动时通过参数设置好初始Metaspace的大小。

参数为： 

```
java -Xmx4g -Xms4g -XX:MetaspaceSize=256m -XX:MaxMetaspaceSize=256m -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+UseParallelGC -Xloggc:/data/motorcycle/logs/gc.log -jar ${APP_NAME} 
```

压测结果为：

```
	Requests per second:    2065.27 [#/sec] (mean)
```

GC日志为：

```
OpenJDK 64-Bit Server VM (25.262-b10) for linux-amd64 JRE (1.8.0_262-b10), built on Aug  6 2020 16:24:19 by "mockbuild" with gcc 4.8.5 20150623 (Red Hat 4.8.5-39)
Memory: 4k page, physical 16265816k(11179736k free), swap 0k(0k free)
CommandLine flags: -XX:CompressedClassSpaceSize=260046848 -XX:InitialHeapSize=4294967296 -XX:MaxHeapSize=4294967296 -XX:MaxMetaspaceSize=268435456 -XX:MetaspaceSize=268435456 -XX:+PrintGC -XX:+PrintGCDateStamps -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseParallelGC 

2021-01-19T13:13:59.532+0800: 3.553: [GC (Allocation Failure) [PSYoungGen: 1048576K->17732K(1223168K)] 1048576K->17828K(4019712K), 0.0270163 secs] [Times: user=0.09 sys=0.01, real=0.03 secs] 
2021-01-19T13:14:03.628+0800: 7.649: [GC (Allocation Failure) [PSYoungGen: 1066308K->34957K(1223168K)] 1066404K->35061K(4019712K), 0.0365319 secs] [Times: user=0.11 sys=0.02, real=0.04 secs] 
以上为启动时的GC日志， 可以看到启动时的FULLGC没有了， 启动过程中只发生了两次YGC， 停顿时间为35ms左右， 对象分配速率在250M/s, 对象提升速率不到1M/s
以下为压测时的GC日志
2021-01-19T13:15:01.162+0800: 65.183: [GC (Allocation Failure) [PSYoungGen: 1083533K->42234K(1223168K)] 1083637K->42378K(4019712K), 0.0373609 secs] [Times: user=0.13 sys=0.01, real=0.04 secs] 
2021-01-19T13:15:03.446+0800: 67.467: [GC (Allocation Failure) [PSYoungGen: 1090810K->41877K(1223168K)] 1090954K->42038K(4019712K), 0.0333692 secs] [Times: user=0.12 sys=0.01, real=0.03 secs] 
2021-01-19T13:15:05.150+0800: 69.171: [GC (Allocation Failure) [PSYoungGen: 1090453K->41865K(1223168K)] 1090614K->42033K(4019712K), 0.0324521 secs] [Times: user=0.13 sys=0.00, real=0.03 secs] 
2021-01-19T13:15:06.781+0800: 70.802: [GC (Allocation Failure) [PSYoungGen: 1090441K->41867K(1340928K)] 1090609K->42051K(4137472K), 0.0374814 secs] [Times: user=0.11 sys=0.03, real=0.04 secs] 
2021-01-19T13:15:08.688+0800: 72.709: [GC (Allocation Failure) [PSYoungGen: 1326987K->11608K(1296896K)] 1327171K->42323K(4093440K), 0.0423222 secs] [Times: user=0.13 sys=0.03, real=0.04 secs] 
2021-01-19T13:15:10.611+0800: 74.632: [GC (Allocation Failure) [PSYoungGen: 1296728K->320K(1331712K)] 1327443K->42147K(4128256K), 0.0118448 secs] [Times: user=0.04 sys=0.00, real=0.01 secs] 
2021-01-19T13:15:12.310+0800: 76.331: [GC (Allocation Failure) [PSYoungGen: 1273152K->384K(1273344K)] 1314979K->42275K(4069888K), 0.0043328 secs] [Times: user=0.01 sys=0.00, real=0.01 secs] 
2021-01-19T13:15:14.127+0800: 78.148: [GC (Allocation Failure) [PSYoungGen: 1273216K->256K(1332736K)] 1315107K->42219K(4129280K), 0.0042036 secs] [Times: user=0.01 sys=0.00, real=0.00 secs] 
2021-01-19T13:15:15.547+0800: 79.568: [GC (Allocation Failure) [PSYoungGen: 1268992K->224K(1333248K)] 1310955K->42267K(4129792K), 0.0040856 secs] [Times: user=0.01 sys=0.00, real=0.00 secs] 
2021-01-19T13:15:16.734+0800: 80.755: [GC (Allocation Failure) [PSYoungGen: 1268960K->160K(1333760K)] 1311003K->42219K(4130304K), 0.0039328 secs] [Times: user=0.02 sys=0.00, real=0.00 secs] 
2021-01-19T13:15:17.898+0800: 81.919: [GC (Allocation Failure) [PSYoungGen: 1269408K->192K(1333248K)] 1311467K->42283K(4129792K), 0.0046647 secs] [Times: user=0.02 sys=0.00, real=0.00 secs] 
2021-01-19T13:15:18.851+0800: 82.873: [GC (Allocation Failure) [PSYoungGen: 1269440K->224K(1336832K)] 1311531K->42363K(4133376K), 0.0048234 secs] [Times: user=0.01 sys=0.00, real=0.01 secs] 
2021-01-19T13:15:19.685+0800: 83.707: [GC (Allocation Failure) [PSYoungGen: 1274592K->192K(1335296K)] 1316731K->42355K(4131840K), 0.0038792 secs] [Times: user=0.01 sys=0.00, real=0.00 secs] 
2021-01-19T13:15:20.609+0800: 84.630: [GC (Allocation Failure) [PSYoungGen: 1274560K->224K(1340928K)] 1316723K->42419K(4137472K), 0.0044144 secs] [Times: user=0.01 sys=0.01, real=0.00 secs] 
2021-01-19T13:15:21.551+0800: 85.572: [GC (Allocation Failure) [PSYoungGen: 1282272K->224K(1338880K)] 1324467K->42443K(4135424K), 0.0035745 secs] [Times: user=0.01 sys=0.00, real=0.01 secs] 
2021-01-19T13:15:22.397+0800: 86.418: [GC (Allocation Failure) [PSYoungGen: 1282272K->128K(1345536K)] 1324491K->42363K(4142080K), 0.0036342 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
2021-01-19T13:15:23.215+0800: 87.236: [GC (Allocation Failure) [PSYoungGen: 1290880K->224K(1342976K)] 1333115K->42475K(4139520K), 0.0035485 secs] [Times: user=0.01 sys=0.00, real=0.00 secs] 
```

结论： 压测时的对象分配速率较高， 基本达到了1G左右/s， 而对象提升速率一直比较低，基本都不到1M/s, 而且每次YGC耗时都比较短， 只有四十多ms，因此， 考虑提升年轻代的大小，减少GC频率，以增加吞吐量

**参数为：相比上次，增加了年轻代的大小， 并且关闭了自适应**

```
java -Xmx4g -Xms4g -Xmn2g -XX:-UseAdaptiveSizePolicy -XX:MetaspaceSize=256m -XX:MaxMetaspaceSize=256m -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+UseParallelGC -Xloggc:/data/motorcycle/logs/gc.log -jar ${APP_NAME} 
```

压测结果：吞吐量又有少量提升

```
Requests per second:    2073.94 [#/sec] (mean)
```

GC日志：

```
OpenJDK 64-Bit Server VM (25.262-b10) for linux-amd64 JRE (1.8.0_262-b10), built on Aug  6 2020 16:24:19 by "mockbuild" with gcc 4.8.5 20150623 (Red Hat 4.8.5-39)
Memory: 4k page, physical 16265816k(11169784k free), swap 0k(0k free)
CommandLine flags: -XX:CompressedClassSpaceSize=260046848 -XX:InitialHeapSize=4294967296 -XX:MaxHeapSize=4294967296 -XX:MaxMetaspaceSize=268435456 -XX:MaxNewSize=2147483648 -XX:MetaspaceSize=268435456 -XX:NewSize=2147483648 -XX:+PrintGC -XX:+PrintGCDateStamps -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:-UseAdaptiveSizePolicy -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseParallelGC 
2021-01-19T13:28:54.871+0800: 4.277: [GC (Allocation Failure) [PSYoungGen: 1572864K->24389K(1835008K)] 1572864K->24437K(3932160K), 0.0316516 secs] [Times: user=0.09 sys=0.02, real=0.03 secs] 
启动时只发生了一次GC， 启动时间也降低了
以下为压测时的GC日志
2021-01-19T13:29:18.014+0800: 27.420: [GC (Allocation Failure) [PSYoungGen: 1597253K->40658K(1835008K)] 1597301K->40810K(3932160K), 0.0543138 secs] [Times: user=0.17 sys=0.03, real=0.05 secs] 
2021-01-19T13:29:21.842+0800: 31.248: [GC (Allocation Failure) [PSYoungGen: 1613522K->42299K(1835008K)] 1613674K->42475K(3932160K), 0.0390903 secs] [Times: user=0.13 sys=0.02, real=0.04 secs] 
2021-01-19T13:29:24.401+0800: 33.807: [GC (Allocation Failure) [PSYoungGen: 1615163K->42197K(1835008K)] 1615339K->42381K(3932160K), 0.0259378 secs] [Times: user=0.09 sys=0.00, real=0.03 secs] 
2021-01-19T13:29:26.805+0800: 36.211: [GC (Allocation Failure) [PSYoungGen: 1615061K->42315K(1835008K)] 1615245K->42508K(3932160K), 0.0459751 secs] [Times: user=0.17 sys=0.00, real=0.04 secs] 
2021-01-19T13:29:28.911+0800: 38.317: [GC (Allocation Failure) [PSYoungGen: 1615179K->42333K(1835008K)] 1615372K->42541K(3932160K), 0.0343565 secs] [Times: user=0.13 sys=0.00, real=0.04 secs] 
2021-01-19T13:29:30.832+0800: 40.238: [GC (Allocation Failure) [PSYoungGen: 1615197K->42421K(1835008K)] 1615405K->42637K(3932160K), 0.0381579 secs] [Times: user=0.14 sys=0.00, real=0.04 secs] 
2021-01-19T13:29:32.699+0800: 42.104: [GC (Allocation Failure) [PSYoungGen: 1615285K->42359K(1835008K)] 1615501K->42583K(3932160K), 0.0390031 secs] [Times: user=0.14 sys=0.01, real=0.04 secs] 
2021-01-19T13:29:34.494+0800: 43.900: [GC (Allocation Failure) [PSYoungGen: 1615223K->42426K(1835008K)] 1615447K->42658K(3932160K), 0.0373989 secs] [Times: user=0.14 sys=0.00, real=0.03 secs] 
2021-01-19T13:29:35.834+0800: 45.239: [GC (Allocation Failure) [PSYoungGen: 1615290K->42427K(1835008K)] 1615522K->42667K(3932160K), 0.0313469 secs] [Times: user=0.10 sys=0.00, real=0.04 secs] 
2021-01-19T13:29:36.986+0800: 46.392: [GC (Allocation Failure) [PSYoungGen: 1615291K->42313K(1835008K)] 1615531K->42561K(3932160K), 0.0267446 secs] [Times: user=0.09 sys=0.00, real=0.02 secs] 
2021-01-19T13:29:38.109+0800: 47.515: [GC (Allocation Failure) [PSYoungGen: 1615177K->42330K(1835008K)] 1615425K->42586K(3932160K), 0.0245832 secs] [Times: user=0.09 sys=0.00, real=0.02 secs] 
2021-01-19T13:29:39.167+0800: 48.573: [GC (Allocation Failure) [PSYoungGen: 1615194K->42377K(1835008K)] 1615450K->42641K(3932160K), 0.0259719 secs] [Times: user=0.10 sys=0.00, real=0.02 secs] 
2021-01-19T13:29:40.280+0800: 49.686: [GC (Allocation Failure) [PSYoungGen: 1615241K->42313K(1835008K)] 1615505K->42577K(3932160K), 0.0296331 secs] [Times: user=0.09 sys=0.00, real=0.03 secs] 
```

可以看到， 年轻代的总大小为1.75G， 小于参数中设置的2g， 猜测是因为JVM中有一套计算最大年轻代大小的机制，在当前硬件条件下， 限制了最大年轻代的大小为1.75G，目前阶段先不纠结于细节，后续需要细看JVM的源码了解。单从结果看， GC频率进一步降低，每次GC的时间稍有增加， 但是也没有超过60ms， 完全满足应用的停顿需求，并且整体的吞吐量稍微增加了一些，满足应用的需求。

最后，取消GC日志，再压测一次， 压测结果为：

```
Requests per second:    2156.13 [#/sec] (mean)
```

取消了GC日志， 吞吐量有进一步的提升。



**由于在用默认参数进行压测时， G1GC也有不错的表现， 再尝试调整G1GC的参数进行压测**

参数为：设置最大停顿时间为100ms， 初始和最大堆内存为4g， 设置初始和最大元数据区大小为256m

```
java $JAVA_OPTS -Xmx4g -Xms4g -XX:MetaspaceSize=256m -XX:MaxMetaspaceSize=256m -XX:+PrintGC -XX:+PrintGCDateStamps -XX:+UseG1GC -XX:MaxGCPauseMillis=100 -XX:G1HeapRegionSize=2m -Xloggc:/data/motorcycle/logs/gc.log -jar ${APP_NAME}
```

压测结果：相对ParallelGC， 还是要差一些

```
	Requests per second:    2035.50 [#/sec] (mean)
```

GC日志为：

```
OpenJDK 64-Bit Server VM (25.262-b10) for linux-amd64 JRE (1.8.0_262-b10), built on Aug  6 2020 16:24:19 by "mockbuild" with gcc 4.8.5 20150623 (Red Hat 4.8.5-39)
Memory: 4k page, physical 16265816k(11150712k free), swap 0k(0k free)
CommandLine flags: -XX:CompressedClassSpaceSize=260046848 -XX:G1HeapRegionSize=2097152 -XX:InitialHeapSize=4294967296 -XX:MaxGCPauseMillis=100 -XX:MaxHeapSize=4294967296 -XX:MaxMetaspaceSize=268435456 -XX:MetaspaceSize=268435456 -XX:+PrintGC -XX:+PrintGCDateStamps -XX:+PrintGCTimeStamps -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseG1GC 
2021-01-19T13:52:28.083+0800: 1.098: [GC pause (G1 Evacuation Pause) (young) 204M->5289K(4096M), 0.0099539 secs]
2021-01-19T13:52:28.695+0800: 1.710: [GC pause (G1 Evacuation Pause) (young) 203M->9215K(4096M), 0.0108401 secs]
2021-01-19T13:52:29.116+0800: 2.131: [GC pause (G1 Evacuation Pause) (young) 202M->12287K(4096M), 0.0087581 secs]
2021-01-19T13:52:29.864+0800: 2.878: [GC pause (G1 Evacuation Pause) (young) 203M->14335K(4096M), 0.0126465 secs]
2021-01-19T13:52:31.160+0800: 4.175: [GC pause (G1 Evacuation Pause) (young) 209M->26623K(4096M), 0.0280770 secs]
2021-01-19T13:52:31.512+0800: 4.527: [GC pause (G1 Evacuation Pause) (young) 203M->25379K(4096M), 0.0244410 secs]
2021-01-19T13:52:31.879+0800: 4.893: [GC pause (G1 Evacuation Pause) (young) 212M->26403K(4096M), 0.0235734 secs]
2021-01-19T13:52:32.962+0800: 5.977: [GC pause (G1 Evacuation Pause) (young) 211M->33471K(4096M), 0.0252601 secs]
2021-01-19T13:52:33.770+0800: 6.785: [GC pause (G1 Evacuation Pause) (young) 216M->40504K(4096M), 0.0383169 secs]
2021-01-19T13:52:34.708+0800: 7.723: [GC pause (G1 Evacuation Pause) (young) 247M->42552K(4096M), 0.0188538 secs]
以上为启动时的日志，由于年轻代的扩容，GC比较频繁
以下为压测时的日志，可以看到停顿时间都在二三十ms， GC频率也不高

2021-01-19T13:53:08.772+0800: 41.786: [GC pause (G1 Evacuation Pause) (young) 497M->51768K(4096M), 0.0265627 secs]
2021-01-19T13:53:12.350+0800: 45.365: [GC pause (G1 Evacuation Pause) (young) 1282M->52792K(4096M), 0.0363587 secs]
2021-01-19T13:53:16.526+0800: 49.541: [GC pause (G1 Evacuation Pause) (young) 2479M->54840K(4096M), 0.0348148 secs]
2021-01-19T13:53:20.308+0800: 53.323: [GC pause (G1 Evacuation Pause) (young) 2479M->52792K(4096M), 0.0222011 secs]
2021-01-19T13:53:23.455+0800: 56.470: [GC pause (G1 Evacuation Pause) (young) 2479M->56888K(4096M), 0.0253990 secs]
2021-01-19T13:53:25.871+0800: 58.886: [GC pause (G1 Evacuation Pause) (young) 2479M->54840K(4096M), 0.0254281 secs]
2021-01-19T13:53:27.805+0800: 60.820: [GC pause (G1 Evacuation Pause) (young) 2479M->52792K(4096M), 0.0241262 secs]
2021-01-19T13:53:29.815+0800: 62.830: [GC pause (G1 Evacuation Pause) (young) 2479M->53816K(4096M), 0.0208603 secs]
2021-01-19T13:53:31.684+0800: 64.699: [GC pause (G1 Evacuation Pause) (young) 2480M->54840K(4096M), 0.0234180 secs]
```

**再次调整参数， 此次人为设置初始年轻代比例，以及最大年轻代比例**

参数为：

```
java -Xmx4g -Xms4g -XX:MetaspaceSize=256m -XX:MaxMetaspaceSize=256m -XX:+UseG1GC -XX:+UnlockExperimentalVMOptions -XX:MaxGCPauseMillis=100 -XX:G1HeapRegionSize=2m -XX:G1NewSizePercent=50 -XX:G1MaxNewSizePercent=60 -XX:+PrintGC -XX:+PrintGCDateStamps -Xloggc:/data/motorcycle/logs/gc.log -jar ${APP_NAME}
```

压测结果：

```
Requests per second:    2107.27 [#/sec] (mean)
```

GC日志：

```
OpenJDK 64-Bit Server VM (25.262-b10) for linux-amd64 JRE (1.8.0_262-b10), built on Aug  6 2020 16:24:19 by "mockbuild" with gcc 4.8.5 20150623 (Red Hat 4.8.5-39)
Memory: 4k page, physical 16265816k(11140540k free), swap 0k(0k free)
CommandLine flags: -XX:CompressedClassSpaceSize=260046848 -XX:G1HeapRegionSize=2097152 -XX:G1MaxNewSizePercent=60 -XX:G1NewSizePercent=50 -XX:InitialHeapSize=4294967296 -XX:MaxGCPauseMillis=100 -XX:MaxHeapSize=4294967296 -XX:MaxMetaspaceSize=268435456 -XX:MetaspaceSize=268435456 -XX:+PrintGC -XX:+PrintGCDateStamps -XX:+PrintGCTimeStamps -XX:+UnlockExperimentalVMOptions -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseG1GC 
2021-01-19T14:02:16.511+0800: 8.888: [GC pause (G1 Evacuation Pause) (young) 2048M->39843K(4096M), 0.0971885 secs]
以上为启动日志
以下为压测日志
2021-01-19T14:02:45.515+0800: 37.891: [GC pause (G1 Evacuation Pause) (young) 2046M->47103K(4096M), 0.0419354 secs]
2021-01-19T14:02:49.089+0800: 41.466: [GC pause (G1 Evacuation Pause) (young) 2047M->47103K(4096M), 0.0356686 secs]
2021-01-19T14:02:52.250+0800: 44.627: [GC pause (G1 Evacuation Pause) (young) 2047M->48127K(4096M), 0.0452387 secs]
2021-01-19T14:02:54.995+0800: 47.372: [GC pause (G1 Evacuation Pause) (young) 2046M->46079K(4096M), 0.0484989 secs]
2021-01-19T14:02:56.771+0800: 49.148: [GC pause (G1 Evacuation Pause) (young) 2046M->46079K(4096M), 0.0355230 secs]
2021-01-19T14:02:58.326+0800: 50.703: [GC pause (G1 Evacuation Pause) (young) 2046M->47103K(4096M), 0.0386832 secs]
2021-01-19T14:02:59.815+0800: 52.191: [GC pause (G1 Evacuation Pause) (young) 2047M->46079K(4096M), 0.0395578 secs]
2021-01-19T14:03:01.247+0800: 53.624: [GC pause (G1 Evacuation Pause) (young) 2046M->46079K(4096M), 0.0464482 secs]
2021-01-19T14:03:02.821+0800: 55.198: [GC pause (G1 Evacuation Pause) (young) 2046M->44031K(4096M), 0.0424669 secs]
```

修改初始新生代参数后，启动时的GC少了很多， 并且吞吐量有进一步的提升